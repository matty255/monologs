{% extends "base.html" %}

{% block content %}
  <h1>{{ post.title }}</h1>

  <div class="prose lg:prose-xl bg-slate-300">{{ post.content.html|safe }}</div>
  <div>
    <p>Posted by {{ post.author }} on {{ post.updated_at }}</p>
    <a href="{% url 'post_update' pk=post.pk %}">Edit</a>

    {% for tag in tags %}
    <span>{{ tag.name }}</span>
{% endfor %}
  </div>

  <div class="post-actions">
    <!-- Like Button -->
    {% if user.is_authenticated %}
      <form method="post" action="{% url 'toggle_like' pk=post.pk %}">
        {% csrf_token %}
        <input type="hidden" name="content_type" value="post">
        <input type="hidden" name="object_id" value="{{ post.id }}">
        <button type="submit">
          {% if liked %}Liked{% else %}Like{% endif %}
          <span>{{ like_count }}
            likes</span>
        </button>
      </form>

    {% endif %}

    <!-- Bookmark Button -->
    {% if user.is_authenticated %}
      <form method="post" action="{% url 'toggle_bookmark' pk=post.pk %}" class="bookmark-form">
        {% csrf_token %}
        <input type="hidden" name="content_type" value="post">
        <input type="hidden" name="object_id" value="{{ post.id }}">
        {% if bookmarked %}
          <button type="submit">Bookmarked</button>
        {% else %}
          <button type="submit">Bookmark</button>
        {% endif %}
      </form>
    {% endif %}
  </div>


  {% for comment in comments %}
    <div>
      <p>{{ comment.author }}: {{ comment.content }}</p>
      {% if not comment.parent %}
        <!-- Reply 버튼 -->
        <button onclick="toggleReplyForm('reply-form-{{ comment.id }}');">Reply</button>
        <div id="reply-form-{{ comment.id }}" style="display:none;">
          {% include 'blog/include/reply_form.html' with parent_id=comment.id form=comment_form %}
        </div>
      {% endif %}
      
      <!-- 대댓글 표시 -->
      {% for reply in comment.replies_list %}
        <div class="reply  pl-4 border-l-2 border-gray-200">
          <p class=" pl-4">{{ reply.author }}: {{ reply.content }}</p>
        </div>
      {% endfor %}
    </div>
  {% endfor %}

  {% include 'blog/include/comment_form.html' with form=comment_form %}
  
{% endblock %}