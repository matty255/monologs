{% extends "base.html" %}

{% block content %}
<h2>Create Category</h2>

<div class="form-group">
  <label for="id_name">Name:</label>
  <input type="text" name="name" class="form-control" id="id_name" required>
</div>
<button type="button" class="btn btn-primary" id="add-category" disabled>Add</button>

<form method="post" id="category-form" action="{% url 'category_create' %}">
  <input type="hidden" name="username" value="{{ request.user.username }}">

    {% csrf_token %}
    
    <button type="submit" class="btn btn-success" id="save-category">Save</button>
</form>

<hr>

<h2>Category Tree</h2>
<div id="category-tree"></div>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.11/themes/default/style.min.css" />

<!-- jsTree 스크립트를 로드합니다. -->
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.11/jstree.min.js"></script>


<script>
  $(function() {
    var selectedNode = null;
    $('#add-category').prop('disabled', false);
  
    $('#category-tree').jstree({
      'core': {
        'data': {{ tree | safe }},
        'check_callback': true
      },
      "plugins": ["wholerow"]
    }).on('loaded.jstree', function() {
      $('#add-category').prop('disabled', !$('#id_name').val().trim());
    });
  
    $('#category-tree').on("select_node.jstree", function(e, data) {
      selectedNode = data.node;
      var hasChildren = data.node.children.length !== 0;
      $('#add-category').prop('disabled', hasChildren);
    }).on('deselect_node.jstree', function(e, data) {
      selectedNode = null;
      $('#add-category').prop('disabled', !$('#id_name').val().trim());
    });
  
    $('#id_name').on('input', function() {
      var isEmpty = !$(this).val().trim();
      $('#add-category').prop('disabled', isEmpty || (selectedNode && selectedNode.children.length !== 0));
    });
  
    $('#add-category').on('click', function() {
      var name = $('#id_name').val().trim();
      if (!name) {
        alert("The name cannot be empty.");
        return;
      }
      if (selectedNode && selectedNode.children.length > 0) {
        alert("Cannot add a category under a child node.");
        return;
      }
      var existingNode = $('#category-tree').jstree('get_node', function(node) {
        return node.text.trim().toLowerCase() === name.toLowerCase();
      });
      if (existingNode) {
        alert('A category with this name already exists.');
        return;
      }
      $('#category-tree').jstree().create_node(selectedNode ? selectedNode.id : '#', {
        text: name
      }, 'last');
      $('#id_name').val('');
      $('#add-category').prop('disabled', true);
    });
  
    $('#category-form').on('submit', function(e) {
      e.preventDefault();
  
      var treeData = $('#category-tree').jstree(true).get_json('#', {
        flat: true
      });
  
      var formData = new FormData(this);
      formData.append('tree', JSON.stringify(treeData));
  
      $.ajax({
        url: this.action,
        type: this.method,
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
          // Handle success
          alert('Saved successfully.');
          if (response.created_nodes && response.created_nodes.length > 0) {
            response.created_nodes.forEach(function(node) {
              // Update the node ID in the jsTree instance
              var jsTreeInstance = $('#category-tree').jstree(true);
              var originalNode = jsTreeInstance.get_node(node.temp_id);
              if (originalNode) {
                jsTreeInstance.set_id(originalNode, node.new_id);
              }
            });
          }
        },
        error: function() {
          // Handle error
          alert('An error occurred while saving.');
          $('#category-tree').jstree('refresh');
        }
      });
    });
  });
  
  </script>

{% endblock %}
